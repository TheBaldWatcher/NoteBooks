[toc]

# OKR

## week 30 —— pre_week

* 06/28快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana
  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share
  * trpc：3月底要扩召回3w
  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳
  * 任务队列：反转实验、log replay、深度召回
    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 共建logreplay
  * 总结：

    * 核对特征一致性
    * 尝试跑流水线
    * 推荐频道反转下线
  * 细则：

    * 10:50 邮件&进度&实验
    * 实验：反转下线，邮件已发
    * 特征中台：
      * mengghu先check user侧特征；item特征等朔爷分支发出来，我切过去，再看，预计是周二
      * 一致性
        * UserVideoCategory2\UserVideoCategory1——coarse有部分值没过滤掉？有个别值转换不对
          * 60779, 89178, 59271, 1096, 37289 vs 60779, 78179, 59271, 1096, 37289
        * UserVideoTagTerms——部分值转换的不对？
        * session：代码未访问，开启一下再看看
        * NewsMaxClickCat1: 乱序问题吗？——打印5个值看看
        * UserclickCat2、UserclickCat1、——OP_parse_action_cat_tag2 改成OP_parse_action_cat_tag看看
        * UserclickNews
    * log replay：
      * 录制通过open api上报到平台——需要了解下open api
      * justinpeng会给我一个分支，便于我自测——快速去了解下流水线
      * 15:14 尝试搭建流水线
* 06/29 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana
  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share
  * trpc：3月底要扩召回3w
  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳
  * 任务队列：反转实验、log replay、深度召回
    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 共建logreplay
  * 总结：

    * 查内存泄漏——没啥结论
    * 看diff、协助朔爷MR
  * 细则：

    * 10:45 邮件&进度
    * 查内存泄漏——没啥结论
    * 特征中台：对比diff，等朔爷合master吧，目前有不少的diff
      * 协助MR：适配朔爷fe分支，调整单测

* 06/30 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana
  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share
  * trpc：3月底要扩召回3w
  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳
  * 任务队列：反转实验、log replay、深度召回
    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 共建logreplay
  * 总结：

    * 手动logreplay::Init，似乎已经能注册上节点，接下来看怎么弄流水线。需要trpc给个可用的版本
    * 协助算法同学发版本
  * 细则：

    * 10:45 邮件&进度
    * 特征
      * 等朔爷merge master
    * logreplay
      * 14:19 trpc-cpp的同学目前依旧没有可用分支，我先手动logreplay::Init看看。遇到permission demied，save模块后解决。继续看看下一步的流水线
    * 协助算法同学发版本
      * 问下husterdang
        * CoarseRanking和真实环境的关系，推送，bin大小写
        * CoarseRanking_EachTriggerDocSize

## week 31

* 07/05 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana
  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share
  * trpc：3月底要扩召回3w
  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳
  * 任务队列：反转实验、log replay、深度召回
    * 自评！！
    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 共建logreplay
    * 删无用的分支
  * 总结：

    * 尝试justinpeng的分支——有core，已反馈
    * merge shuoyang的分支，尝试跑流水线
    * 晚上组会，过OKR等
  * 细则：

    * 10:30 邮件&进度
    * 10:54 和justinpeng语音：
      * domain统一都用api.tone.woa.com/logreplay
      * 插件注册是否需要挪到框架内部？——另外，宏开关控制代码是进行logreplay，这个开关加在业务还是框架？——加在框架里
    * 特征中台
      * 15:00 等MR过
      * 问下shuoyang，怎么配个ranking的环境
    * logreplay
      * 15:14 package(default_visibility = ["//visibility:public"])
    * 组会——OKR
      * logreplay
* 07/06 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana
  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share
  * trpc：3月底要扩召回3w
  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳
  * 任务队列：反转实验、log replay、深度召回
    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 共建logreplay
    * 删无用的分支
  * 总结：

    * logreplay有core，justinpeng在看，我先继续对特征
    * SessionXXX特征主要是查index失败，暂时不解；UserClickXXX、UserVideoXXX要继续看下
  * 细则：

    * 10:35 邮件&进度
    * 特征中台
      * 问下shuoyang，怎么配个ranking的环境——他给我个机器。我需要找honghao确认是ip: port还是需要polaris
      * 跑12-13点的日志
        * Session是两边查redis各自有失败率——扩容？
        * ~~UserClickCat1/Cat2 切换分支后，已解决~~
        * UserclickNews/UserclickCat1/UserclickCat2：coarse比rank多一位，rank全部都是-1结尾——对应的是哪个ranking特征？
          * UserclickCat1 295/323,  (323-295)/18596=0.00150570015057
          * UserclickCat2 295/323
          * UserclickNews  295/323
        * UserVideoCategory2\UserVideoCategory\
          * 主要是video的diff
    * logreplay
      * 遗留 package(default_visibility = ["//visibility:public"]) 
      * justinpeng还在装环境
      * 15:17 justinpeng确认是他代码有bug，他先看看
    * 其他
      * 跟一下正式环境有两台机器异常的问题——重启后解决（上周无法重启）
* 07/07 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana
  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share
  * trpc：3月底要扩召回3w
  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳
  * 任务队列：反转实验、log replay、深度召回
    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 共建logreplay
    * 删无用的分支
  * 总结：

    * 部署debug链路，查diff：
      * ClickSequenceXXX diff万分之4，且都为ranking在开头多一位
      * UserVideoXXX 需要继续调整log
  * 细则：

    * 10:40 邮件&进度
    * fe
      * qqnews.Recommend.CoarseRanking.feature_extractor  -> coarse
      * qqnews.Recommend.CoarseRanking.feature_extractor_old_model -> ranking
      * 15:55 debug链路搭建起来，开始对比
* 07/08 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana
  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share
  * trpc：3月底要扩召回3w
  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳
  * 任务队列：反转实验、log replay、深度召回
    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 共建logreplay
    * 删无用的分支
  * 总结：

    * user 侧特征已对齐，代码从个人仓库修改后，放到正式仓库
    * Item特征待check——有点忘了当时是怎么check的了
  * 细则：

    * 10:40 邮件&进度
    * 15:26 UserVideoClick原因查明：GetVideoProfileIndex的差异，ranking会多一些值，这些值有重复，resize - uniq后，会比coarse少。（我总觉得ranking的逻辑是个历史bug）
    * 16:10 左右，开始跑log，准备一会儿用mengghu的脚本对比
    * 18:00 不太记得item怎么对比的了，问了下mshuaizhang和mengghu，也不是特别清楚。
* 07/09 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana
  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share
  * trpc：3月底要扩召回3w
  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳
  * 任务队列：反转实验、log replay、深度召回
    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 共建logreplay
    * 删无用的分支
  * 总结：

    * 对item的特征
  * 细则：

    * 10:40 邮件&进度
    * 17:36 和mengghu核对item
    * logreplay要了一份可以用的分支，我需要在这个分支上看open api的新接口
      * zhengfu调通了sdk，但是目前trpc高版本在有流量打过来的时候还是会core（之前是初始化就会core），需要等zhengfu cherry-pick一下，弄个低版本的trpc；另外回头他会发一下sdk的分支代码。下周开始调试流水线



* ```
  coarse_ranking_base_ = std::unique_ptr<CoarseRankingBase>(
        static_cast<CoarseRankingBase*>(DynObjectFactory::CreateObject(service_name)));
    
    感觉写的不太优雅
  ```

## week 32 

* 上周总结：
  * 特征中台
    * 协助shuoyang的op的merge
    * 核对user测特征：SessionXXX 5%是key刚创建，查不到；UserVideoXXX是粗排未和ranking对齐。user测特征已ok，diff率千分位
    * 核对item特征：mengghu跑流水线任务中。我这边手动跑python3 untitled.py，发现diff蛮大的，下周问问mengghu那边的情况
  * logreplay
    * justinpeng之前给的分支有core，说是只要是trpc0.8+就会有core。已让他在0.7版本上cherry-pick一下。
    * 另外，他说open api接口有变动，但我之前应该都能把节点注册上。不过他说已经基于旧版本调通了。后续我再看看新open api有啥变动
    * 周一他会给我个可用的trpc和sdk版本，**我需要尽快调通流水线，本周deadline**

* 07/12 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：反转实验、log replay、深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 共建logreplay
    * 删无用的分支

  * 总结：

    * logreplay 录制和回放还没有调通：录制有数据，但是回放失败。另外，没有下游接口的数据
    * 特征：item对不齐，怀疑是不是输入的数据就不对

  * 细则：

    * 10:50 邮件&进度

    * logreplay 

      * 14:20 justinpeng给的分支似乎可用。我后续调一下流水线
      * bazel build :coarse_ranking --define include_replay_logreplay=true --copt="-D LOGREPLAY_DEBUG_STDOUT"
      * Justinpeng：录制有数据，但是回放失败，怀疑录制的还是有问题
      * justinpeng给了我分支，我帮着一起看，但感觉给的分支有问题

    * 特征中台

      * NSH coarse和rank hash出来的值不对应2830 vs 5354

      * video

        * NewsTagTerms 54420 0.4640375186527393
          VideoTagTerms 18539 0.15808143253037732
          NewsEventArtHeat 7558 0.0644468130462588——时序特征
          NewsCategoryL2 3291 0.02806224685568109——Category_Old

      * article

        * NSH 73839 0.7984493609290858 —— ranking是""？
          NewsCategoryL2 16741 0.18102683881571832——Category_Old
          NewsEventArtHeat 11246 0.12160730119596012——时序特征
          NewsImgNum-NewsType 7024 0.07595319967992388——依赖NewsImgNum
          NewsImgNum 6967 0.07533683686930946
          NewsTagTerms 2828 0.03058024611258894

          * ```
            20210710A0B3QQ00
            ```

        * NewsEventLevel 2383 0.02576829083673955
          DetailPageStyle-NewsCate1 1697 0.018350310344081834
          NewsEntityTag 1674 0.018101602543307598
          NewsCategoryL1 1374 0.014857587750600143——Category_Old？

* 07/13 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana
  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share
  * trpc：3月底要扩召回3w
  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳
  * 任务队列：反转实验、log replay、深度召回
    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 填写周报
    * 共建logreplay
    * 删无用的分支
  * 总结：

    * logreplay 录制和回放还没有调通：录制有数据，但是回放失败。另外，没有下游接口的数据
    * 特征：item对不齐，怀疑是不是输入的数据就不对
  * 细则：

    * 10:00 邮件&进度
    * 特征中台
      * NSH coarse和rank hash出来的值不对应2830 vs 5354
      * video
        * NewsTagTerms 54420 0.4640375186527393
          VideoTagTerms 18539 0.15808143253037732
          NewsEventArtHeat 7558 0.0644468130462588——时序特征
          NewsCategoryL2 3291 0.02806224685568109——Category_Old
      * article
        * NSH 73839 0.7984493609290858 —— ranking是""？
          NewsCategoryL2 16741 0.18102683881571832——Category_Old
          NewsEventArtHeat 11246 0.12160730119596012——时序特征
          NewsImgNum-NewsType 7024 0.07595319967992388——依赖NewsImgNum
          NewsImgNum 6967 0.07533683686930946
          NewsTagTerms 2828 0.03058024611258894
          NewsEventLevel 2383 0.02576829083673955
          DetailPageStyle-NewsCate1 1697 0.018350310344081834
          NewsEntityTag 1674 0.018101602543307598
          NewsCategoryL1 1374 0.014857587750600143——Category_Old？

* 07/14 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：反转实验、log replay、深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 填写周报
    * 共建logreplay
    * 删无用的分支

  * 总结：

    * item对不齐：离线切新架构并没有完全完成；另外NewsId为什么对不齐还需要看一下
    * 开始看logreplay的下游调用为何没录制上

  * 细则：

    * 10:30 邮件&进度

    * case

      * ```
        20210630A04D6800
        ```

    * 17:28 
      * NewsCategoryL2 “早上我们和离线内容同学归因，发现离线切新架构并没有完全完成。目前线上离线、在线存在diff。”——等他们修复下
      * NewsId 比较奇怪，同样的local_id算出来的hash_id不一致。手算了一下，和coarse是一致的，不知道ranking那边啥问题，mengghu再跑一下venus任务看看
    * 17:30 开始看logreplay 调下游: client

* 07/15 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 填写周报
    * 共建logreplay
    * 删无用的分支

  * 总结：

    * logreplay: justinpeng已初步调通回放；下游录制需要使用MakeClientContext，但仍有context为空的情况，需要继续看看

  * 细则：

    * 10:35 邮件&进度
    * logreplay
      * 16:23 定位到需要用MakeClientContext，但业务代码中没有用，所以下游调用都记录表——改一下接口，透传下看看
      * justinpeng那边已经能回放了，但是有些字段对不齐，可能需要看看——主要是coarse_ranking_score，另外，不知道对于数组，在做diff时有顺序要求么

* 07/16 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 填写周报
    * 共建logreplay
    * 删无用的分支

  * 总结：

    * log replay  的redis req_data设置的有问题

  * 细则：

    * 10:50 邮件&进度
    * 特征中台：
      * 14:30 跑一版071612的数据

## week 33

* 上周总结：
  * 特征中台：
    * item特征对不齐
      * 离线切新架构未完全完成
      * NewsId等mengghu跑个融合后的数据——怀疑是

* 07/19 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 填写周报
    * 共建logreplay
    * 删无用的分支

  * 总结：

    * logreplay：
      * 调试diff流水线：排序的预处理有问题
      * 目前coarse_ranking_score、doc_score分数不一致。把下游录制了应该可解

  * 细则：

    * 10:40 邮件&进度
    * 11:00 看logreplay的parent id和commit id
    * 14:11 justinpeng那边还在debug redis的序列化。我先找浩东要一个无随机性的召回，看看能否去掉一些随机性，以调试流水线
      * 15:39 Coarse_ranking_score暂时加入黑名单，先不比较
      * 15:15 diff预处理排序问题，反馈在群里，另外找savageliu在看。我先看看coarse ranking score为啥会不一样：看看taf能记录不。
      * 19:23 taf的记录似乎有问题。还是等justinpeng那边的结果吧；另外，diff预处理的排序似乎有问题
* 07/20 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 填写周报
    * 共建logreplay
    * 删无用的分支

  * 总结：

    * logreplay：
      * 协助看core、召回录制会导致route出错，待查
      * 问rspdiff，似乎比较麻烦，拉群跟进

  * 细则：

    * 10:30 邮件&进度
    * 看了下向量检索的文档
    * 15:10 协助justinpeng看看core问题
    * 召回的录制似乎会导致route的问题
* 07/21 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 填写周报
    * 共建logreplay
    * 删无用的分支

  * 总结：

    * logreplay：
      * 查trigger导致的route问题——SetCallerName
      * redis回放似乎已经ok了，coarse_ranking_score字段似乎没有不一致了
      * 协助rspdiff解决排序问题，解决中
    * 特征中台：
      * 反馈mengghu跑的merge后的信息，似乎有问题。她重新跑了下：“815518777, 815518779 这个两个，一个是把 None的去掉，一个是把整个item 打出来”

  * 细则：

    * 10:30 邮件&进度
    * 15:16 协助lucalai debug rspdiff排序问题。debug trigger导致的route问题
    * trigger是由于SetCallerName
* 07/22 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 填写周报
    * 共建logreplay
    * 删无用的分支

  * 总结：

    * logreplay：找可参考的流水线并参考

  * 细则：

    * 10:50 邮件&进度
    * 当前的想法是，在流水线里做个类似双环境回放，编译两个bin（分别对应新旧代码），然后gor从线上copy一份流量过来，然后收集这两份rsp，做diff。有些地方不知道怎么处理：
      1、手动logreplay回放的时候，是要设置实例节点的，比如打开“总开关”，设置服务器类型为“录制”/“回放”。流水线里要怎么做呢？
      2、这两份rsp如何收集起来？如何做diff？怎么拿到diff的结果
      3、如果diff不通过，可能要人工看看有哪些diff，怎么弄一个连接出来，让开发同学转跳过去
    * 19:03 找一些可参考的流水线：
      * 通过Astra的监听触发，可以设置一些用于判断不同业务的变量
      * 不同业务自己找台机器，部署logreplay版的机器——另外每次推全后，可能需要更新下record log
      * 把编译的镜像部署到上一步提到的机器，然后通过【logreplay回放】插件，进行回放
* 07/23 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征
    * 填写周报
    * 共建logreplay
    * 删无用的分支

  * 总结：

    * logreplay：开发http，目前似乎replay的时候拿不到数据

  * 细则：

    * 10:50 邮件&进度
    * 15:00 准备自己开发http
    * 19:17 似乎回放的时候，GetRecord里aspects_是空的，这是不是有问题？——GetAspects的aspects

## week 34

* 上周总结：

  * logreplay：
    * rspdiff排序规则不生效，协助排查——下周解决
    * SetCallerName——会导致路由问题，具体原因未解决
    * 开发http录制——回放有问题
  * item：等待索引文件ready

* 07/27 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征——索引文件更新了，check下

  * 总结：

    * 特征：适配item，venus任务跑不起来，需要看看脚本
    * logreplay：http的make client context的route错误需要解决

  * 细则：

    * 10:40 邮件&进度

    * 11:00 看logreplay sdk代码，不清楚replay时的数据是从哪来的

    * 14:00 看下离线文件的切换

      * ```c++
        bool RuleRouterCluster::CalculateRouteResult(std::vector<RuleRouterSet*>& result,
                                                     uint32_t* sum_weight, float percent_of_min_instances,
                                                     bool enable_recover_all) {
          if (data_.empty()) {
            return false;
          }
        ```

* 07/28 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征——索引文件更新了，check下

  * 总结：

    * 特征：离线文件diff无法界定：总体diff50%，但NewsId有30%diff，需要先解决NewsId的问题

  * 细则：

    * 10:20 邮件&进度
    * 11:38 调完了venus任务，能跑起来了。正在跑2021072712的数据

* 07/29 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征——索引文件更新了，check下

  * 总结：

    * 值周
      * 重启高内存的机器，ons迁移北极星20%
    * 特征
      * NewsId有问题，多值的占比41.8%。反馈给shuoyang；尝试key变为origin_news_id + NewsId

  * 细则：

    * 10:00 邮件&进度
    * 值周
      * 10:40 重启部分高内存的机器，都是40核40G。
      * 由于ons已下线，需要迁移到北极星。开个实验来做这个事情，初步放量1%，逐渐到20%
        * 11:27 放量1% -> 2%
        * 14:17 放量2% -> 4%
        * 15:32 放量4% -> 10%
        * 16:24 放量10% -> 20%
    * 特征：
      * `cat  tot_dhf| sed "s#.*\(NewsId[^]]*]\).*\(ori_newsid[^]]*]\).*#\2 \1#g" > dhf_sed`
      * 2021072712里，共有ori_newsid 301,378个，其中有多个值的有125,989个，占比41.8%
      * 把NewsId能对上的筛出来看看。key变为origin_news_id + NewsId

* 07/30 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * trpc：3月底要扩召回3w

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 对下特征——索引文件更新了，check下

  * 总结：

    * 值周：开mshuaizhang的上线；ons迁移polaris放量至50%
    * 特征：临时方案暂不切换；NewsId反馈给yuyanshi

  * 细则：

    * 10:40 邮件&进度
    * 值周
      * 11:45 看mshuaizhang的上线
      * 14:39 放量20% -> 30%
      * 16:11 放量30% -> 40%
      * 21:25 放量40% -> 50%
    * 特征
      * 11:45 一会儿适配下新索引，同时看看能不能origin_news_id + NewsId join一下
      * origin_news_id + NewsId join后，还是有一些diff，考虑到长期方案下周二左右能ready，临时方案暂不切换
      * NewsId的问题讨论后，目前是yuyanshi在查

## week 35 

* 上周进度

  * logreplay： 需要解决http录制时，路由报错的问题
  * 特征：适配临时方案依然有diff，直接用下周二的长期方案。排查NewsId的问题。

* 08/02 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * 值周：ons迁移polaris有问题，策略开在了联合层，导致会冲掉一些联合层的实验。实验已下线，修改配置后由husterdang准备重开
    * logreplay：不是非连续buffer使用的非标准接口导致的问题；

  * 细则：

    * 10:30 邮件&进度
    * logreplay
      * 10:51 external/polaris_api/polaris/plugin/service_router/rule_router.cpp:106
      * 不是因为ncb导致的
    * 其他
      * ons迁移polaris: 14:20放量60% -> 80%；16:08放量 80% -> 100%
      * 被调耗时涨了20ms。待查

* 08/03 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * logreplay：路由问题和logreplay无关，似乎是个历史问题，定位中

  * 细则：

    * 10:30 邮件&进度
    * ons迁移polaris
      * 现在的实验策略无法判断是层域、灰度。以前优先级是层域>灰度>基线；现在灰度会冲掉层域。估计得反馈给changxiaoli
      * 另外，当前的灰度层域放量的办法，应该是行不通了，问问kexing看看怎么搞
      * 另外关注下耗时——和昨天情况类似，polaris的耗时高15ms左右
        * 14:18 权重改成1000在看看
        * 20:53 似乎新的代码才是正确的？旧的代码由于没有传server context，所以规避掉了问题？
    * logreplay
    * 《编写高性能服务程序（CPU内存篇）-IDP-T-北京-20210803》课程群
      * 如何查找瓶颈
        * Top、火焰图、strace—见—手机照片
        * cacheline，局部性

* 08/04 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * logreplay：开发GetHashString、HttpProtocl的From/ToString

  * 细则：

    * 09:30 邮件&进度
    * logreplay：
      * 14:30 早上把路由问题抛出来。但这个似乎可以暂时规避掉，我先想办法赶快调通流程。在开发TRPC_HTTP_NCB_MESSAGE的To/FromString
      * ~~17:13 手动设置LogreplayContext，先绕开MakeClientContext，这个接口有问题，就算不设置CallerName，也会报101~~
      * 22:43 手动设置LogreplayContext，先绕开MakeClientContext——报101的问题是GetHashString里GetNonContiguousProtocolBody会消耗数据
      * 明日要点：
        * 和kexing推进http的路由问题
        * 如何自动化
        * 组会展示

* 08/05 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * Logreplay 回放偶尔成功，偶尔失败

  * 细则：

    * 09:30 邮件&进度

    * logreplay

      * 和kexing推进http的路由问题

      * 如何自动化

      * 组会展示

      * 14:52 logreplay能回放起来，但是偶尔会失败。部分失败时arr len not eq；部分似乎是平台显示矛盾

        * | 是否过大 | 任务traceid                      | 是否成功 | 备注                                           | 任务                |
          | -------- | -------------------------------- | -------- | ---------------------------------------------- | ------------------- |
          | 1是      | 81355297622279676be088b7966643ea | 否       | array-len-not-equal                            | 23377               |
          | 2是      | 81355279004583915745231bc324068c | 否       | array-len-not-equal                            | 23378               |
          | 3是      | 8135526931046197f9e33daafae9073f | 否       | array-len-not-equal                            | 23379               |
          | 4否      | 00016281355264133dbf03b379b1d7f2 | 是       |                                                | 23380               |
          | 5是      | 2889478297517546aaf87264a27c514e | ?        | 偶尔失败，失败似乎是平台本身问题，数据显示矛盾 | 23381，23383        |
          | 6是      | 8135524647392015677e92a999d20caa | 否       | array-len-not-equal                            | 23384               |
          | 7是      | 8135522115161034688a6fb5f4182476 | 否       | array-len-not-equal                            | 23386               |
          | 8是      | 8135521269678538811fd7e9afcd4a16 | 否       | array-len-not-equal                            | 23389               |
          | 9是      | 81355219765368205101bc73e5b9986b | 否       | array-len-not-equal                            | 23390               |
          | 10是     | 81355212703409981b76f1fbb46e6b8b | 否       | array-len-not-equal                            | 23393               |
          | 11是     | 26871297451805568de4a0213fe7a33a | ？       | 偶尔失败，失败无信息                           | 23307，23398，23399 |
          | 12是     | 2660779878904652f18097948f4dc71b | 是       |                                                | 23401               |
          | 13是     | 263435438855451907c772ecbca0bbc4 | 是       |                                                | 23402               |

      * Commit24 : 内部限制为500 doc + 粗排分排序+ + 配置里都加上filter logreplay

      * commit 25: 内部限制为500 doc + doc id排序 +配置里都加上filter logreplay

      * commit 26: 16:02, 内部先按doc排序，再截断（之前是先截断再排序）

      * commit 27 截断到100

      * commit 28：打一下log

      * 成功or失败？**23472**

      * 失败**23431**

* 08/06 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * 

  * 细则：

    * 10:30 邮件&进度
    * logreplay
      * 14:42 有几路似乎存在随机性。直接关闭UnaryInvoke看看，如果没有数据就是没录制上；如果有数据则是录制上了，但由于某些边界情况导致回放有问题？
      * 15:45 是mock数据没有替换上。已fix
      * 16:11 logreplay似乎抽风了，回放没有流量。

## week 36

* 08/09 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * logreplay路由问题：多环境路由，目前部署不支持，暂时关闭
    * logreplay回放失败：似乎是有重复的，需要调整key 

  * 细则：

    * 10:00 邮件&进度
    * logreplay
      * 11:15 平台回放有问题。先看看多环境路由
    * 其他: 
      * 14:47 Disable_request_timeout是不是不太合理，后面压测一下
      * 16:38 路由问题：目前代码未启用多环境路由，基线代码由于server context信息缺失，所以在查路由信息的时候失败，没有进行多环境路由；新代码把信息传了进去，查路由信息成功，但是由于目前不支持多环境路由（没有节点），导致路由失败。暂时先关闭多环境路由，后续支持了再打开
    * 19:26 开会讨论要点
      * 离线、在线——自动化流水
      * MR 同步流水、后续再异步流水。
      * 单测开关的on off都要测——最好有一个平台，统一管理
      * 开实验最好有个shadow环境——流水线触发发布，发布到预发布环境——
      * 发布不再区分小流量或基线，同样的bin，特性由开关项控制
      * 主干开发先在粗排上打通。步骤：logreplay——预发布——开关项flag管理
* 08/10 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * logreplay：粗排的trigger的ons有重复，导致回放拿到多条数据，按出错处理。目前加了去重
    * http、taf、redis都可以录制。索引需要改代码，明天再看看

  * 细则：

    * 10:00 邮件&进度
    * 16:41 logreplay偶尔失败，有个原因是对同一个ons召回了多次，导致GetRecord报错；去重后，回放失败率下降很多，但还是存在。看看是不是log导致的，关闭debug相关的log——似乎关掉log能减少一些超时率，但还是有部分失败。暂时不管了
    * 17:13 开始大规模测试下trigger的http，没有问题的话，验证后面的redis taf 等。——commit 47
      * commit 48: 开启redis  —— okay
      * commit 49: 开启redis，并在回放时，关闭掉正常请求 ——22号请求，trigger的record比replay多1，任务**23844**
      * commit 50: 开启taf
* 08/11 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * logreplay：关闭item的cache，尝试改索引失败（后面再看吧）；批量回放失败率比较高（不只是超时，也有diff）

  * 细则：

    * 10:45 邮件&进度
    * logreplay
      * 15:14 commit 54: 关闭item的cache, cache导致有些请求不会走网络调用，即不会有录制；导致回放时，这些请求没数据
      * 16:45 commit 59: 关闭内部的排序处理——目前内部是有序的，没有触发到这个功能，等后续触发了再看
      * 20:53 批量回放会失败，排查原因中，先把doc数下调为200试试
* 08/12 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * logreplay：top的virt很高，加上老出一些oom的core，怀疑内存有泄漏。似乎是ncb的问题，排查中

  * 细则：

    * 10:45 邮件&进度
    * logreplay
      * 11:10 似乎有内存泄漏，top virt涨的特别快，基本上100G/s。待查
      * 12:20 定位到是parse_rsp_ret_code = rsp_pb->ParsePartialFromZeroCopyStream(&nis);具体原因排查中
* 08/13 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * logreplay解决内存问题：void * cast导致申请了很大的内存。

  * 细则：

    * 10:45 邮件&进度
    * logreplay
      * 11:51 多线程和oom都有问题
      * 16:16 似乎偶尔会失败，粗排分很奇怪，有的77，有的88。多录制一段时间看看
      * 16:36 录制了1346条
      * 17:27 存在上报失败的情况，看看openapi是不是要加个重试
      * 21:23 virt大的问题已解。void *的cast有问题，导致FlattenSlow里string的reserve了一个超大的值，几十M

## week 37

* 本周工作：
  1、logreplay：http、redis、taf等都可以录制，但目前录制/回放qps先设置为1，高了会出core，待查。准备接入到流水线
    a、解决http路由问题：trpc默认支持多环境路由，隔离Production/Development环境。但粗排下游并不是都有Development环境，因此会找不到可用的下游服务，导致路由出错。之所以以前测试环境没有这个问题，是因为少传了server context的信息，导致路由信息拼接的不对，没有启用对应的路由规则。目前先把测试环境的多环境路由关闭了，后续等下游服务支持了再开启。
    b、debug内存问题：录制/回放一段时间后会崩，主要是oom的堆栈。原因是有个void *在reinterpret_cast时，没有转换成正确的类型，后续reserve时，使用了很大的值。
    c、其他：logreplay cpp sdk在上报失败时，没有重试，会导致回放时，录制数据中没有对应请求，产生diff。后续需要加个重试

  下周计划：
  1、logreplay：
    a、流水线demo
    b、debug 高qps时的core问题
    c、logreplay cpp sdk加重试等功能

* 08/16 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * iCode训练营
    * logreplay：
      * 整理代码，push到git，以便灿哥调试demo
      * 但晚上回放失败。看上去是录制数据缺失：补充下logreplay sdk上报重试、队列满载
      * 明天和justingpeng对一下trpc代码MR流程和时间点

  * 细则：

    * 11:00 邮件&进度
    * 14:13 调整代码，准备push
    * iCode训练营
      * CR
        * 评审行数200~400行；量低于500行/h；时长低于1h
        * 设计层面、实现层面、规范层面
  
* 08/17 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * iCode训练营
    * logreplay：
      * fix一个时间特征导致的回放失败
      * 查看justinpeng的代码，不需要merge，直接用他的就行
      * 但这需要适配一下trpc最新版

  * 细则：

    * 10:00 邮件&进度
    * 12:00 iCode
    * logreplay
      * 16:18 和samuelcui、kexingshi讨论logreplay的问题。另外发现有个时间特征会导致回放失败，改了之后应该失败率会小很多。qps和上报失败的情况待查

* 08/18 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * logreplay：
      * 适配新的astra代码，适配新的trpc——taf、item-redis配置；logreplay配置&注册代码

  * 细则：

    * 10:40 邮件&进度
    * 19:40 
      * 需要适配新版trpc。既然husterdang已经适配了最新的trpc了，我只适配了一部分。那干脆直接merge他的；
      * astra代码更新导致taf和item-redis都变了，而我配置文件未适配，导致出错：codec_使用默认值trpc，并生成对象，后续void * cast时不适配，导致内存出core
      * 另外，logreplay调整了filter逻辑，需要业务自己注册logreplay，框架不再帮忙注册

* 08/19 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * logreplay：回放不稳定，调试代码。目前定位到是need calculate导致to_rank、no_rank分组发生变动

  * 细则：

    * 10:00 邮件&进度
    * logreplay

* 08/20 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业、键盘膜
    * 股票、安居、居住证
    * should report的实现？
    * 周末：补牙、洗牙、攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄

  * 总结：

    * logreplay：索引会导致稳定性问题：fix 没有设置server client导致的没有录制上的问题；目前发现数据太大，导致上报不稳定，且容易出core，打算调小、调快上报逻辑

  * 细则：

    * 09:30 邮件&进度
    * logreplay:
      * 看起来像是因为缺少index，导致need calculate出现差异
      * all.news_rec_search_forward_cache.redis.com
      * all.rec_index_dynamic_feature_redis_prod.redis.com
      * 周六：
        * 索引由于没有设置server context，导致录制补上
        * 另外，还需要关闭一下多环境路由
        * 目前发现会有不上报的问题，似乎 LOGREPLAY::Asyncer::GetInstance().RunPeriod(一段时间之后就没在刷新log了。回放时会有失败的情况，拉正排失败了，怀疑和这个周期任务停止有关
        *  external/trpc_cpp/trpc/filter/logreplay/logreplay_client_filter.cc:
        * external/trpc_cpp/trpc/filter/logreplay/util.cc:164
        *  grep " __dhf" ../log/trpc.log -a  | awk ' {sum += $9}END{print sum/1024/1024}'
        * 似乎是索引的数据太大了，其他下游服务才70M，索引能差不多跑到2020M。28倍

## week 38

* 本周工作：
  1、logreplay：调试流水线；适配trpc新版本 、调试稳定性
    a、流水线：更新代码，以便灿哥调试流水线。过程中解决一个时间特征导致的回放失败
    b、trpc-logreplay发生了rebase，从v0.7 rebase 到v0.8，需要适配。接口、文件变动，导致粗排、新旧索引都需要调整。
    c、debug 录制/回放的稳定性：索引的数据量很大，一次请求大概会有30M数据。批量上报时，容易出http413错误。调试中。
    d、更新单测

  下周计划：
  1、logreplay：astra MR

* 08/23 快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业
    * 股票、安居、居住证
    * should report的实现？
    * 周末：攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 体检

  * 总结：

    * logreplay，整理代码，准备提MR，单测遇到些问题
    * 给mengghu落日志，对比user——UserVideoXXX和SessionXXX6个特征有较大diff，明天看一下

  * 细则：

    * 10:00 邮件&进度
    * 10:35 编一版master，给mengghu落下user日志
    * 14:31 日志落完。开始改代码，准备提MR

* 08/24快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业
    * 股票、安居、居住证
    * should report的实现？
    * 周末：攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 体检

  * 总结：

    * logreplay 更新单测——部分单测注释掉、写了个http server context的构造，但是似乎有多线程问题
    * 特征：查看case，是有些fix代码没同步。同步后，只有sessionxxx的差异，都是redis失败，但是有30%，明天再跑一版log

  * 细则：

    * 09:30 继续改MR的单测
    * 10:20 邮件&进度
    * logreplay 调试单测，写server context
    * 特征：查看user侧的diff case，由于用的是master的代码，feature分支的一些fix没有同步过去。下午的log看上去，只有session xxx有较大的diff，30%。基本上都是coarse 查redis失败了，以前是5%。不知道这次为什么这么大。不太想查，想直接起实验看效果。

* 08/25快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业
    * 股票、安居、居住证
    * should report的实现？
    * 周末：攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 体检

  * 总结：

    * logreplay 
      * MR单测能跑过了，但部分是注释掉的
      * 有个上报间隔的参数没有设置，导致不上报，修了之后能上报了，但是回放失败，切回放1条后，节点不可选，需要重启

  * 细则：

    * 09:30 继续改MR的单测
    * 12:04 3422f793.qqnews.coarse_ranking.tj100041给shuoyang做测试
    * 20:25 单测该了一版，能编过了。部分单测是暂时先注释掉的。调试下record和replay

* 08/26快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业
    * 股票、安居、居住证
    * should report的实现？
    * 周末：攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 体检

  * 总结：

    * logreplay 
      * 流水线的录制数据为空，我本地的代码非空，但有diff，看样子是redis-item没有录制上，看看能不能fix后用这个代码
    * 特征：session 30%待查

  * 细则：

    * 09:30 一会儿要给samuelcui一个版本调试流水线，先验证下，没问题一会儿发出去。
    * Logreplay:
      * 16:19 早上起的实验有问题，起到了【新用户】层；已重开，并有流量
    * 特征：
      * session 30%diff还是不可接受，还是得查

* 08/27快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业
    * 股票、安居、居住证
    * should report的实现？
    * 周末：攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 体检

  * 总结：

    * logreplay 
      * redis序列化失败是因为codec使用了缺省值
      * 索引由于namespace和route导致没录上
      * 修复后，发现redis序列化/反序列化有问题，且只为新索引
    * 特征：session 30%待查

  * 细则：

    * 09:00 进度
    * logreplay
      * 10:57 redis的问题似乎是因为codec使用了缺省值
      * 下午的时候，测试流量打到了线上，导致线上AServer超时。原因是使用了新的特征，特征size变了
      * 周六14:12 索引没录上，导致有diff。发现录制/回放时，key拼的有问题
        * -all.rec_index_dynamic_feature_redis_prod.redis.com//1167823128432205811
        * -all.news_rec_search_forward_cache.redis.com//1167823128432205811, ff278f1e664b1502ff278f1e664b1502
      * 周日 
        * 19:14 dynamic的cache没有关
        * 索引的redis解析失败Get Mock Respons

## week 39

* 上周工作
  * logreplay：
    * 适配trpc v0.8：有些配置以前用的默认值；现在不设置会导致一些问题（redis序列化失败、logreplay不上报等）
    * 整理代码、调整单测，提一版MR，已包含主要改动。单测代码还需继续调整。
    * 新正排索引：fix 由于多环境路由导致的录制问题；关闭动态索引的cache（之前只关掉了非动态）；似乎正排索引FlexBuffer比较特殊，在redis的反序列化时会出错，排查中。
  * 新模型特征：再次check user侧特征。Session有30%diff，目前看是redis返回Nil。但diff和为Nil比例为何这么大，待进一步解释。

* 08/27快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业
    * 股票、安居、居住证
    * should report的实现？
    * 周末：攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 体检

  * 总结：

    * logreplay 
      * 解决redis序列化/反序列化
      * 测试环境流水线已ok
    * 特征：session 30%待查

  * 细则：

    * 09:00 进度
    * logreplay
      * 16:14 fix redis反序列化的问题
      * 20:39 似乎可以回放上了，但是偶尔会失败，有一次是record的user为空；另外，批量回放很容易超时——似乎是log相关，换成非gdb版本就好了
      * 21:46 批量录制有问题，pop的log会突然不刷
      * 记得配一下diff策略、目前在粗排代码里进行id排序
      * 写一下wiki
      * 23:10 似乎调通了，整理代码，并准备在hongfendong.coarse_ranking上测一下
    * 特征
      * session待查
* 08/31快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业
    * 股票、安居、居住证
    * should report的实现？
    * 周末：攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 体检

  * 总结：

    * logreplay 
      * 在replay环境上莫名失败
    * 特征
      * 在线log复现了问题，似乎是history index导致的。排查中

  * 细则：

    * 09:00 进度
    * logreplay
      * 在replay环境上莫名地回放失败，问问adhuang
    * 特征
      * 11:55 准备跑下debug链路
      * 准备了debug链路，跑了下：key无diff，redis返回值有/无值，diff比例很低189/4158=4.5%
      * 发现是history index的差异，排查中。index 的 key diff很小
* 09/01快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业
    * 股票、安居、居住证
    * should report的实现？
    * 周末：攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 体检

  * 总结：

    * Logreplay: 回放失败时超时引起的，似乎是pre的logreplay，5s+
    * 特征：
      * diff是因为历史索引ranking改了个查询参数，粗排没有对齐。
      * 明天等mengghu和kalowang好了之后起实验

  * 细则：

    * 09:00 进度
    * logreplay 
      - 回放数据处理失败似乎是超时引起的，5s+
    * 特征
      - 发现diff是由于ranking代码更新，更改了历史索引的Mode，从DOCINFO改为了DOCINFO_DICT_INDEPENDENT
      - 12:16 开始落日志，准备对比diff
      - 17:17 还是有8%diff。考虑到ranking线上268台，coarse ranking130台，调小50%流量，再录1小时
        - diff 7%，基本可用
* 09/02快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 中期：了解DAG、依赖图/计算图——并发配置化、Cpu亲和性/false share

  * 低优先级

    * 香港保险、作业
    * 股票、安居、居住证
    * should report的实现？
    * 周末：攀岩、消防绳

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * 体检

  * 总结：

    * Logreplay: 
      * 数据包过大，20-40M，加上跨机房传输，导致回放超时。先用同机房（深圳）看看能否规避问题。另外让adhuang评估下是否能放宽超时+下调qps
    * 特征：
      * 准备起实验，准备环境

  * 细则：

    * 09:00 进度
    * logreplay
      * GetAspects 4.8s
      * 由于数据过大，20-40M，导致耗时过长，被平台判定为超时。adhuang那边评估下是否能放宽超时、降低qps为小数
      * 由于samuelcui的环境是天津机器，和logreplay平台通信时出现了跨机房。让samuelcui试试深圳环境，看看能否继续调试流水线
    * 新模型
      * 准备起实验
        * experiment_base2.coarse_ranking
        * experiment_test5.coarse_ranking
        * experiment_test4.coarse_ranking
    * 下半年的okr
* 09/03快速的提升工程素养，和团队一起将粗排建设成一流水平

  * 长期：core guide、gmock，bazel、hana

  * 低优先级

    * 香港保险、作业
    * 股票、安居、居住证
    * should report的实现？
    * 周末：攀岩、消防绳、体检

  * 任务队列：深度召回

    * deep retrieval https://arxiv.org/abs/2007.07203
      TDM https://zhuanlan.zhihu.com/p/78941783
    * 会议纪要怎么弄
    * okr

  * 总结：

    * Logreplay: 
      * 数据包过大，20-40M，加上跨机房传输，导致回放超时。先用同机房（深圳）看看能否规避问题。另外让adhuang评估下是否能放宽超时+下调qps
    * 特征：
      * 准备起实验，准备环境

  * 细则：

    * 10:00 进度
    * 特征：
      * 10:08 调试实验环境
      * 19:38 起实验
    * Logreplay:
      * 15:31 调整完一版单测，跑跑MR流水线看看。另外看是看看samuelcui说的流水线依然不行的问题
      * 手动回放能跑过，让samuelcui再试一下
      * MR已发大群。继续改MR流水线





* 机器使用

* * 3422f793.qqnews.coarse_ranking.tj100041  shuoyang

* 准备起实验
  * experiment_base2.coarse_ranking
  * experiment_test5.coarse_ranking
  * experiment_test4.coarse_ranking

* bazel build :coarse_ranking --define include_replay_logreplay=true --copt="-D LOGREPLAY_DEBUG_STDOUT"
* external/trpc_cpp/trpc/filter/logreplay/filter_logreplay_client.cc
  * b external/trpc_cpp/trpc/filter/logreplay/filter_logreplay_client.cc:38 if dhf
  * b external/logreplay/logreplay/context.cc:154
  * b astra/coarse_ranking/components/trigger.cpp:56
  * b external/polaris_api/polaris/plugin/service_router/rule_router.cpp:37
  * b external/polaris_api/polaris/plugin/service_router/rule_router.cpp:106
* astra/coarse_ranking/business/ynews_business/ynews_coarse_ranking.cpp
* astra/coarse_ranking/coarse_ranking.cpp
  *  src_rule_data->outbounds_
    * src_route_rule->RouteRule()
      * ServiceRouteRule* source_route_rule = route_info.GetSourceServiceRouteRule();
      * route_info = std::any_cast<std::shared_ptr<polaris::RouteInfo>>(list_result.info);
      *   if (0 != List(list_router_info, list_result)) {
  *  matched_route      = &outbounds[i];
    * = src_rule_data->outbounds_
    * src_route_rule->RouteRule() -> outbounds_
    * route_info.GetSourceServiceRouteRule()->RouteRule() -> outbounds_
    * list_result.info->GetSourceServiceRouteRule()->RouteRule() -> outbounds_
      *  if (0 != List(list_router_info, list_result)) {
      * route_info->SetSourceServiceRouteRule(new polaris::ServiceRouteRule(source_route_rule_service_data));
  * Ontrigger
    * external/trpc_cpp/trpc/client/http/http_service_proxy.cc:21
    * external/trpc_cpp/trpc/client/service_proxy.cc:52
    *  external/trpc_cpp/trpc/client/service_proxy.cc:386
    *  external/polaris_api/polaris/plugin/service_router/service_router.cpp:207
  * 400301
    * external/trpc_cpp/trpc/naming/polaris/trpc_server_connector.cc:424
    *  external/trpc_cpp/trpc/naming/polaris/polaris_service_discovery.cc:487
  * filter
    * external/trpc_cpp/trpc/filter/logreplay/filter_logreplay_client.cc:166

 exclude = [

​        "src/framework/**/*test.cpp",

​    ]),

* coarse vs ranking对齐流程
  * 机器准备：找一台线上play做gor流量copy；找一台测试环境的play，并部署debug版；找一台coarse、一台ranking
  * 准备ons：目前play_debug用不了polaris，只能用ons。
  * 打印日志，awk 过滤后，用user/diff.py 跑一下。日志格式：trace_id set_id:val1,va2;

* 

* 周进度

* 特征中台：
  * mengghu先check user侧特征；item特征等朔爷分支发出来，我切过去，再看，预计是周二
  * 一致性
    * UserVideoCategory2\UserVideoCategory1——coarse有部分值没过滤掉？有个别值转换不对
      * 60779, 89178, 59271, 1096, 37289 vs 60779, 78179, 59271, 1096, 37289
    * UserVideoTagTerms——部分值转换的不对？
    * session：代码未访问，开启一下再看看
      * SessionTagList：有4%左右的diff，发现均是rank或coarse中，某一方未查到。
        * 样本: 566(corase空) 441(rank空) 1017（总diff）——1017-566-441=10
      * SessionCate1List: 类似SessionTagList
        * 样本: 567(corase空) 445(rank空) 1018（总diff）——1018-567-445=6
      * SessionCate2List: 类似SessionTagList
        * 样本: 551(corase空) 437(rank空) 996（总diff）——996-551-437=8
    * NewsMaxClickCat1: 乱序问题吗？——打印5个值看看
    * UserclickCat2、UserclickCat1、——OP_parse_action_cat_tag2 改成OP_parse_action_cat_tag看看
    * UserclickNews
* log replay：
  * 录制通过open api上报到平台——需要了解下open api
  * justinpeng会给我一个分支，便于我自测——快速去了解下流水线
  * 15:14 尝试搭建流水线
  * 需要手动改配置文件：tracing -> replay
  * 需要用MakeClientContxt
  * diff   https://iwiki.woa.com/pages/viewpage.action?pageId=543187958
    * 可以添加白名单、黑名单
    * 数组：^to_rank_docinfo\[.*].coarse_ranking_score
    * 不要把logreplay的发布到线上，目前放弃了性能，以便更好的处理代码（copy临时对象）
    * TRPC_HTTP_NCB_MESSAGE
  * 二期
    * 流量编辑
    * 请求级覆盖RBC

  

* 多环境路由
  * 被调入流量规则 > 主调出流量规则